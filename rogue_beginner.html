<html>
   <head>
	  <title>Game-for delta</title>
   </head>
   <body>
       <div id = "instruction">
         <ul>
           <li>Press the space bar to start the game</li>
           <li>You have 90 seconds to reach the checkpoint</li>
         </ul>
       </div>
       <canvas id = "canvas" height = "400" width = "400"></canvas>
       <div id = "time"></div>

   <script type="text/javascript">
        

        var canvas = document.getElementById("canvas");
        var ctx = null;
        var gameMap= [
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0,
  0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 3,
  0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0,
  0, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0,
  0, 1, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1, 1, 1, 0,
  0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0,
  0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0,
  0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0,
  0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0,
  0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0,
  0, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 0,
  0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1, 0,
  0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
];
        var Map = [
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
	0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0,
	0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0,
	0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0,
	0, 1, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0,
	0, 1, 0, 1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0,
	0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0,
	0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 1, 0,
	0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0,
	0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0,
	0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0,
	0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0,
	0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0,
	0, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0,
	0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0,
	0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0,
	0, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0,
	0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 0, 1, 0,
	3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0,
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
];



        var tileH = 40;//tile height and width set to 40px
        var tileW = 40;
        var mapH=15; //number of tiles
        var mapW=15; 
        var currentSecond = 0, frameCount = 0, framesLastSecond = 0; var lastFrameTime = 0;
        var player = new Character();
        var brick = new Image;
        var wallPicture = new Array();
        brick.src = "http://www.clker.com/cliparts/b/m/0/m/n/D/brick-wall-jail.svg";
        var player_Pic = new Image;
        player_Pic.src = "https://themovieuniverse.files.wordpress.com/2012/04/wall-e.png";
        var exit;
        var timeStart,gameTime = 0;

        var time = 0;
        var gamePlay;
        var fiveMinutes = 30*1;
        var spaceBarPressed = false;
        var status = 0;
        var i = 1;
        //var fiveMinutes = ("level" + n).gameTime;

        function level(n){//building a level object using a constructor to characterize each of the three levels
           //this.gameMap = "gameMap" + n;//nth level corresponds to the nth element of the gamemap array
           this.height = n*5 + 15;
           this.width = n*5 + 15;
           this.gameTime = 90 + (n*60);
           this.wallPicture = wallPicture[n];
           this.mapH = n*5 + 15;
           this.mapW = n*5 + 15;
        }

        var level0 = new level(0);
        var level1 = new level(1);
        var level2 = new level(2);
        
        
        var keysDown = {
        	37: false,//left arrow
        	38: false,//up arrow
        	39: false,//right arrow
        	40: false//down arrow
        };

        /*var button = document.createElement("input");
        button.setAttribute("type","submit");
        button.setAttribute("value","Start");
        button.setAttribute("id","start_btn");
        document.body.appendChild(button); 

           button.addEventListener("click",function(){
           display = document.querySelector('#time');
           startTimer(fiveMinutes, display);
           //gamePlay = requestAnimationFrame(drawGame);
           //ctx = canvas.getContext("2d");

        })*/

        var viewport = {//creating a viewport object
        	screen:     [0,0],//dimensions of the canvas width and height
        	startTile:  [0,0],//the top left tile from which the canvas is starting
          endTile:    [0,0],//the bottom right tile at which the canvs finishes
          offSet:     [0,0],//the pixels by which we draw relative position with respect to which we will draw the canvas

          update:  function(px,py){//here px and py are the coordinates of the points around which the viewport is centered
            	this.offSet[0] = Math.floor((this.screen[0]/2)-px);//set new offsets according to the px and py value
            	this.offSet[1] = Math.floor((this.screen[1]/2)-py);


            	var tile = [
            		Math.floor(px/tileW),
            		Math.floor(py/tileH)
            	];


            	this.startTile[0] = tile[0] - 1 -Math.ceil((this.screen[0]/2)/tileW);
            	this.startTile[1] = tile[1] - 1 - Math.ceil((this.screen[1]/2)/tileH);

            	if(this.startTile[0]<0){this.startTile[0]=0;}//checking for boundary conditions for the startTile
            	if(this.startTile[1]<0){this.startTile[1]=0;}

            	this.endTile[0] = tile[0] + 1 + Math.ceil((this.screen[0]/2)/tileW);
            	this.endTile[1] = tile[1] + 1 + Math.ceil((this.screen[1]/2)/tileH);

            	if(this.endTile[0]>=mapW){this.endTile[0] = mapW;}
            	if(this.endTile[1]>=mapW){this.endTile[1] = mapH;}

            },

        }

        function Character(){//class that gives all the information about the character or player's movement and position
         	this.tileFrom = [1,1];//position of the tile the character is moving from
         	this.tileTo = [1,1];//position of the tile it is moving to
         	this.timeMoved = 0; //time since it started moving
         	this.dimension = [30,30];//dimension of the character 
         	this.position = [45,45];//absolute position of the character
         	this.delay = 700; //700ms delay
         }

            Character.prototype.placeAt = function(x,y)
            {//method to place the function to x,y position
            	this.tileFrom = [x,y];
            	this.tileTo = [x,y];
            	this.position[0] = x*tileW + ((tileW-this.dimension[0])/2);
            	this.position[1] = y*tileH + ((tileH-this.dimension[1])/2);
            };

            Character.prototype.processMovement = function(t)
            {
            	if(this.tileFrom[0]==this.tileTo[0] && this.tileFrom[1]==this.tileTo[1]){   
            	                                                  //since the character has already moved to it's destination file 
            		return false;
            	}
            	if(t-this.timeMoved>=this.delay){
            	    this.placeAt(this.tileTo[0],this.tileTo[1]);
            	}

            	else{
            		this.position[0] = tileW*this.tileFrom[0] + ((tileW-this.dimension[0])/2);
            		this.position[1] = tileW*this.tileFrom[1] + ((tileW-this.dimension[1])/2);
            	

            	        if(this.tileTo[0]!=this.tileFrom[0]){
            		        var diff = (tileW/this.delay)*(t-this.timeMoved);
            		        this.position[0] += (this.tileTo[0]<this.tileFrom[0]) ? 0-diff:diff;
            		             }

                    	if(this.tileTo[1]!=this.tileFrom[1]){
                    		var diff = (tileH/this.delay)*(t-this.timeMoved);
            		        this.position[1] += (this.tileTo[1]<this.tileFrom[1]) ? 0-diff:diff;
            		             }	     
            		this.position[0] = Math.round(this.position[0]);
            		this.position[1] = Math.round(this.position[1]);

            	}
            		     
                return true;

            }

            function toIndex(x,y){
            	return (x+(y*mapW));
            }


    
        window.onload = function(){
           ctx = canvas.getContext("2d");
        	// gamePlay = requestAnimationFrame(drawGame);
        	ctx.font = "bold 10pt sans-serif";
          timeStart = Math.floor(Date.now()/1000);

          //var fiveMinutes = 30 * 1,
           display = document.querySelector('#time');
        //startTimer(fiveMinutes, display);


        	window.addEventListener("keyup",function(e){
              if(e.keyCode>=37&&e.keyCode<=40){
              	keysDown[e.keyCode] = false;
              if(e.keyCode==32&&status==0){
                spaceBarPressed = false;

                status++;
              }
              }
        	});
        	window.addEventListener("keydown",function(e){
              if(e.keyCode>=37&&e.keyCode<=40){
              	keysDown[e.keyCode] = true;
              }
              if(e.keyCode==32&&status==0){
                spaceBarPressed = true;
                 display = document.querySelector('#time');
                 gamePlay = requestAnimationFrame(drawGame);
                 startTimer(fiveMinutes, display);
                 var info = document.getElementById("instruction");
                 info.style.display = "none";                 
                 status++;
              }
        	});

          

        	viewport.screen = [document.getElementById("canvas").width,document.getElementById("canvas").height];
        };  
         

      function startTimer(duration, display) {
    var timer = duration, minutes, seconds;

    function  timerDisplay() {
        minutes = parseInt(timer / 60, 10);
        seconds = parseInt(timer % 60, 10);

        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;

        display.textContent = minutes + ":" + seconds;
        ctx.fillStyle = "#ff0000";
        ctx.fillText("Time: " + minutes + ":" + seconds, 10, 30);
        ctx.fill();


        if (--timer < 0) {
            timer = duration;
        }
    }
    function check(){
        if(minutes=="00"&& seconds == "00")
        {
          cancelAnimationFrame(gamePlay);
          clearInterval(game);

        }
    }
    timerDisplay();
    var game = setInterval(function(){
      timerDisplay()
      check()
    }, 1000);
}


        function drawGame()
        {  
            

                   
              if(ctx==null){
              
              	return;
              }
                var currentFrameTime = Date.now();
                var timeElapsed = currentFrameTime - lastFrameTime; 
                gameTime += timeElapsed;  
                                
                var sec = Math.floor(Date.now()/1000);
              if(currentSecond!=sec){
              	currentSecond = sec;
              	framesLastSecond = frameCount;
              	frameCount = 1
              }
              else{
              	frameCount++;
              }

              if(!player.processMovement(currentFrameTime)){

              	// *We check for 3 conditions before moving the character to a tile
              	//* if the right key is pressed, if it's position is not out of bounds and if the new position is ascessable 

                if(keysDown[37]&&player.tileFrom[0]>0&&gameMap[toIndex(player.tileFrom[0]-1,player.tileFrom[1])]==1){
                	player.tileTo[0] -= 1;//to move to the left
                  
                  if(keysDown[37]&&player.tileFrom[0]>0&&toIndex(player.tileFrom[0]-1,player.tileFrom[1]) == exit){
                    alert("you have reached the next level");
                  }
                    
                   // window.location = 'timer.html';
                  }//to check if the the next level exit has been reached
  
                else if(keysDown[38]&&player.tileFrom[1]>0&&gameMap[toIndex(player.tileFrom[0],player.tileFrom[1]-1)]==1){
                    player.tileTo[1] -= 1;//to move up
                  }
                else if(keysDown[39]&&player.tileFrom[0]<(mapW-1)&&gameMap[toIndex(player.tileFrom[0]+1,player.tileFrom[1])]==1){
                     if(toIndex(player.tileFrom[0]+1,player.tileFrom[1])==exit){
                      alert("next level");
                     }
                    player.tileTo[0] += 1;//to move to the right
                  }
                else if(keysDown[40]&&player.tileFrom[1]<(mapH-1)&&gameMap[toIndex(player.tileFrom[0],player.tileFrom[1]+1)]==1){
                    player.tileTo[1] += 1;// to move down
                   }

                if(player.tileTo[0]!=player.tileFrom[0]||player.tileFrom[1]!=player.tileTo[0]){
                       player.timeMoved = currentFrameTime;
                   }

                  } 
                  viewport.update(player.position[0]+(player.dimension[0]/2),player.position[1]+(player.dimension[1]/2));   
                  ctx.fillStyle = "#000000";
                  ctx.fillRect(0,0,viewport.screen[0],viewport.screen[1]);



              for(var y = viewport.startTile[1]; y<viewport.endTile[1];y++){
              	for(var x =viewport.startTile[0];x<viewport.endTile[0];x++){

              		switch(gameMap[y*mapW+x])
              		{
              		case 0:
					           //ctx.drawImage(brick,viewport.offSet[0]+x*tileW,viewport.offSet[1]+ y*tileH,tileW,tileH);
                     ctx.fillStyle = "#00ff0b";
                     ctx.fillRect(x*tileW+viewport.offSet[0],y*tileH+viewport.offSet[1],tileW,tileH);
                   // exit = ((y*mapW)+x);

					           break;
                  case 3:                     
                    ctx.fillStyle = "#f0e04b";
                    ctx.fillRect(x*tileW+viewport.offSet[0],y*tileH+viewport.offSet[1],tileW,tileH);
                    exit = ((y*mapW)+x);
                    break;
				        default:
					          ctx.fillStyle = "#cc000c";
					          ctx.fillRect(x*tileW+viewport.offSet[0],y*tileH+viewport.offSet[1],tileW,tileH);
              		}
              		
              	}
              }

              ctx.fillStyle = "#FF00ff";
              ctx.fillRect(player.position[0]+viewport.offSet[0],player.position[1]+viewport.offSet[1],player.dimension[0],player.dimension[1]);
              //ctx.drawImage(player_Pic,player.position[0]+viewport.offSet[0],player.position[1]+viewport.offSet[1],player.dimension[0],player.dimension[1]); 


	          ctx.fillStyle = "#ff0000";
	          ctx.fillText("FPS: " + framesLastSecond, 10, 20);

            //ctx.fillStyle = "#ff0000";
            //ctx.fillText(cTime, 30, 40);
            
	         gamePlay =  requestAnimationFrame(drawGame);
           

         }


         

   </script>
   

</body>
</html>